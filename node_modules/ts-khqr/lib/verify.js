"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.verifyQR = void 0;
const constants_1 = require("./constants");
const utils_1 = require("./utils");
const cloneObject = (obj) => JSON.parse(JSON.stringify(obj));
function verifyQR(qrString) {
    const allTags = constants_1.KHQR_TAG.map((item) => item.tag);
    const subTags = constants_1.KHQR_TAG.filter((item) => item.sub === true).map((item) => item.tag);
    let requiredTags = constants_1.KHQR_TAG.filter((item) => item.required === true).map((item) => item.tag);
    const tags = [];
    let lastTag = '';
    let isMerchantTag = false;
    while (qrString) {
        const cutQRString = utils_1.StringUtils.cutString(qrString);
        const { value, slicedString } = cutQRString;
        let { tag } = cutQRString;
        if (tag === lastTag)
            break;
        const isMerchant = tag === '30';
        if (isMerchant) {
            tag = '29';
            isMerchantTag = true;
        }
        if (allTags.includes(tag)) {
            tags.push({ tag, value });
            requiredTags = requiredTags.filter((item) => item !== tag);
        }
        qrString = slicedString;
        lastTag = tag;
    }
    // check required tag and throw invalid
    if (requiredTags.length > 0) {
        const requiredTag = requiredTags[0];
        const missingInstance = constants_1.KHQR_TAG.find((item) => item.tag === requiredTag);
        if (missingInstance) {
            /* tslint:disable:no-unused-expression */
            new missingInstance.instance(requiredTag, null);
        }
    }
    tags.forEach((khqrTag) => {
        const { tag } = khqrTag;
        let { value } = khqrTag;
        const khqr = constants_1.KHQR_TAG.find((item) => item.tag === tag);
        let inputValue = value;
        if (khqr) {
            if (subTags.includes(tag)) {
                const subTagInput = constants_1.KHQR_SUBTAG.input.find((item) => item.tag === tag);
                if (subTagInput) {
                    const inputdata = cloneObject(subTagInput.data);
                    while (value) {
                        const { tag: subtag, value: subtagValue, slicedString: slicedsubtag, } = utils_1.StringUtils.cutString(value);
                        const nameSubtag = constants_1.KHQR_SUBTAG.compare
                            .filter((item) => item.tag === tag)
                            .find((item) => item.subTag === subtag);
                        if (nameSubtag) {
                            if (isMerchantTag && nameSubtag.name === 'accountInformation') {
                                const merchantID = 'merchantID';
                                inputdata[merchantID] = subtagValue;
                            }
                            else {
                                inputdata[nameSubtag.name] = subtagValue;
                            }
                            inputValue = inputdata;
                        }
                        value = slicedsubtag;
                    }
                    new khqr.instance(tag, inputValue);
                }
            }
            else {
                new khqr.instance(tag, inputValue);
            }
        }
    });
}
exports.verifyQR = verifyQR;
